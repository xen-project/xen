\chapter{Installing Xen on Debian}

The Debian project provides a tool called \path{debootstrap} which
allows a base Debian system to be installed into a filesystem without
requiring the host system to have any Debian-specific software (such as
\path{apt}).

Here's some info on how to install Debian 3.1 (Sarge) for an
unprivileged Xen domain:

\begin{enumerate}

\item Set up Xen and test that it's working, as described earlier in
  this manual.

\item Create disk images for rootfs and swap. Alternatively, you might
  create dedicated partitions, LVM logical volumes, etc.\ if that suits
  your setup.
\begin{verbatim}
dd if=/dev/zero of=/path/diskimage bs=1024k count=size_in_mbytes
dd if=/dev/zero of=/path/swapimage bs=1024k count=size_in_mbytes
\end{verbatim}
  If you're going to use this filesystem / disk image only as a
  `template' for other vm disk images, something like 300 MB should be
  enough. (of course it depends what kind of packages you are planning
  to install to the template)

\item Create the filesystem and initialise the swap image
\begin{verbatim}
mkfs.ext3 /path/diskimage
mkswap /path/swapimage
\end{verbatim}

\item Mount the disk image for installation
\begin{verbatim}
mount -o loop /path/diskimage /mnt/disk
\end{verbatim}

\item Install \path{debootstrap}. Make sure you have debootstrap
  installed on the host. If you are running Debian Sarge (3.1 / testing)
  or unstable you can install it by running \path{apt-get install
    debootstrap}. Otherwise, it can be downloaded from the Debian
  project website.

\item Install Debian base to the disk image:
\begin{verbatim}
debootstrap --arch i386 sarge /mnt/disk  \
            http://ftp.<countrycode>.debian.org/debian
\end{verbatim}
  You may use any Debian mirror that you want.

\item When debootstrap completes successfully, modify settings:
\begin{verbatim}
chroot /mnt/disk /bin/bash
\end{verbatim}

  Edit the following files using vi or nano and make any required
  changes:
\begin{verbatim}
/etc/hostname
/etc/hosts
/etc/resolv.conf
/etc/network/interfaces
/etc/networks
\end{verbatim}

  Set up access to the services. Edit:
\begin{verbatim}
/etc/hosts.deny
/etc/hosts.allow
/etc/inetd.conf
\end{verbatim}

  Add Debian mirror to:
\begin{verbatim}
/etc/apt/sources.list
\end{verbatim}

  Create fstab like this:
\begin{verbatim}
/dev/sda1       /       ext3    errors=remount-ro       0       1
/dev/sda2       none    swap    sw                      0       0
proc            /proc   proc    defaults                0       0
\end{verbatim}

  Logout

\item Unmount the disk image
\begin{verbatim}
umount /mnt/disk
\end{verbatim}

\item Create Xen 3.0 configuration file for the new domain. You may use
  the example-configurations provided with Xen as a template.

  Make sure you have the correctly configured:
\begin{verbatim}
disk = [ 'file:/path/diskimage,sda1,w', 'file:/path/swapimage,sda2,w' ]
root = "/dev/sda1 ro"
\end{verbatim}

\item Start the new domain
\begin{verbatim}
xm create -f domain_config_file
\end{verbatim}

  Check that the new domain is running:
\begin{verbatim}
xm list
\end{verbatim}

\item Attach to the console of the new domain. You should see something
  like this when starting the new domain:

\begin{verbatim}
Started domain testdomain2, console on port 9626
\end{verbatim}
        
  You can see the ID of the console: 26. You can also list the consoles
  with \path{xm consoles}. ID is the last two digits of the port number.

  Attach to the console:

\begin{verbatim}
xm console 26
\end{verbatim}

  or by telnetting to the port 9626 of localhost. The xm console program
  works better.

\item Log in and run base-config

  By default there is no password set for root.

  Check that everything looks OK, and the system started without errors.
  Check that the swap is active, and the network settings are correct.

  Run \path{/usr/sbin/base-config} to configure the Debian settings.

  Set the password for root using \path{passwd}.

\item Done. You may exit the console by pressing {\path{Ctrl + ]}}

\end{enumerate}

If you need to create new domains, you can copy the contents of the
`template'-image to the new disk images, either by mounting the template
and the new image, and using \path{cp -a} or \path{tar} or by simply
copying the image file. Once this is done, modify the image-specific
settings (hostname, network settings, etc).
